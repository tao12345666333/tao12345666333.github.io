<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>è¢« Google é€‰æ‹©çš„ä¸‹ä¸€ä»£æ•°æ®é¢ Cilium æ˜¯ä»€ä¹ˆ - MoeLove</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-1876963677156202",enable_page_level_ads:true});</script><meta name=author content="å¼ æ™‹æ¶›"><meta name=description content="èƒŒæ™¯ åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç«  K8S ç”Ÿæ€å‘¨æŠ¥| Google é€‰æ‹© Cilium ä½œä¸º GKE ä¸‹ä¸€ä»£æ•°æ®é¢ ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»‹ç»äº† Google å®£å¸ƒä½¿ç”¨ Cilium ä½œä¸º GKE çš„ä¸‹ä¸€ä»£æ•°æ®é¢ï¼ŒåŠå…¶èƒŒåçš„æ•…äº‹ã€‚
Google é€‰æ‹© Cilium ä¸»è¦æ˜¯ä¸ºäº†å¢åŠ  GKE å¹³å°çš„å®¹å™¨å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ã€‚é‚£ä¹ˆï¼ŒCilium åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¼ºçš„å¸å¼•åŠ›å‘¢ï¼Ÿ
æ‘˜ä¸€æ®µå®˜ç½‘çš„ä»‹ç»ï¼š
 Cilium is open source software for transparently securing the network connectivity between application services deployed using Linux container management platforms like Docker and Kubernetes.
 Cilium æ˜¯ä¸€ä¸ªç”¨äºé€æ˜ä¿æŠ¤éƒ¨ç½²åœ¨ Linux å®¹å™¨ç®¡ç†å¹³å°ï¼ˆæ¯”å¦‚ Docker å’Œ Kubernetesï¼‰ä¸Šçš„åº”ç”¨æœåŠ¡ä¹‹é—´ç½‘ç»œè¿æ¥çš„å¼€æºè½¯ä»¶ã€‚
ä¸ºä»€ä¹ˆç€é‡å¼ºè°ƒæ˜¯ â€œLinux å®¹å™¨ç®¡ç†å¹³å°â€ å‘¢ï¼Ÿè¿™å°±ä¸å¾—ä¸æåˆ° Cilium çš„å®ç°äº†ã€‚Cilium çš„åŸºç¡€æ˜¯ä¸€ç§ç§°ä¸º eBPF çš„ Linux å†…æ ¸æŠ€æœ¯ï¼Œä½¿ç”¨ eBPF å¯ä»¥åœ¨ Linux è‡ªèº«å†…éƒ¨åŠ¨æ€çš„æ’å…¥ä¸€äº›æ§åˆ¶é€»è¾‘ï¼Œä»è€Œæ»¡è¶³å¯è§‚å¯Ÿæ€§å’Œå®‰å…¨æ€§ç›¸å…³çš„éœ€æ±‚ã€‚"><meta name=keywords content="MoeLove,Linux,Docker,Kubernetes,Golang,Python,Container,Vim,å®¹å™¨,k8s"><meta name=baidu-site-verification content="jO2rMlnjJi"><meta name=google-site-verification content="googlefe3fc086c62f7210.html"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://moelove.info/2020/09/02/%E8%A2%AB-Google-%E9%80%89%E6%8B%A9%E7%9A%84%E4%B8%8B%E4%B8%80%E4%BB%A3%E6%95%B0%E6%8D%AE%E9%9D%A2-Cilium-%E6%98%AF%E4%BB%80%E4%B9%88/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.8c3cbcb0324c2bb4875ceccba4007cbad4b4ac8377f33af9953c3e7684534a50.css rel=stylesheet><link href=/lib/fancybox/jquery.fancybox-3.1.20.min.css rel=stylesheet><meta property="og:title" content="è¢« Google é€‰æ‹©çš„ä¸‹ä¸€ä»£æ•°æ®é¢ Cilium æ˜¯ä»€ä¹ˆ"><meta property="og:description" content="èƒŒæ™¯ åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç«  K8S ç”Ÿæ€å‘¨æŠ¥| Google é€‰æ‹© Cilium ä½œä¸º GKE ä¸‹ä¸€ä»£æ•°æ®é¢ ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»‹ç»äº† Google å®£å¸ƒä½¿ç”¨ Cilium ä½œä¸º GKE çš„ä¸‹ä¸€ä»£æ•°æ®é¢ï¼ŒåŠå…¶èƒŒåçš„æ•…äº‹ã€‚
Google é€‰æ‹© Cilium ä¸»è¦æ˜¯ä¸ºäº†å¢åŠ  GKE å¹³å°çš„å®¹å™¨å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ã€‚é‚£ä¹ˆï¼ŒCilium åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¼ºçš„å¸å¼•åŠ›å‘¢ï¼Ÿ
æ‘˜ä¸€æ®µå®˜ç½‘çš„ä»‹ç»ï¼š
 Cilium is open source software for transparently securing the network connectivity between application services deployed using Linux container management platforms like Docker and Kubernetes.
 Cilium æ˜¯ä¸€ä¸ªç”¨äºé€æ˜ä¿æŠ¤éƒ¨ç½²åœ¨ Linux å®¹å™¨ç®¡ç†å¹³å°ï¼ˆæ¯”å¦‚ Docker å’Œ Kubernetesï¼‰ä¸Šçš„åº”ç”¨æœåŠ¡ä¹‹é—´ç½‘ç»œè¿æ¥çš„å¼€æºè½¯ä»¶ã€‚
ä¸ºä»€ä¹ˆç€é‡å¼ºè°ƒæ˜¯ â€œLinux å®¹å™¨ç®¡ç†å¹³å°â€ å‘¢ï¼Ÿè¿™å°±ä¸å¾—ä¸æåˆ° Cilium çš„å®ç°äº†ã€‚Cilium çš„åŸºç¡€æ˜¯ä¸€ç§ç§°ä¸º eBPF çš„ Linux å†…æ ¸æŠ€æœ¯ï¼Œä½¿ç”¨ eBPF å¯ä»¥åœ¨ Linux è‡ªèº«å†…éƒ¨åŠ¨æ€çš„æ’å…¥ä¸€äº›æ§åˆ¶é€»è¾‘ï¼Œä»è€Œæ»¡è¶³å¯è§‚å¯Ÿæ€§å’Œå®‰å…¨æ€§ç›¸å…³çš„éœ€æ±‚ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://moelove.info/2020/09/02/%E8%A2%AB-Google-%E9%80%89%E6%8B%A9%E7%9A%84%E4%B8%8B%E4%B8%80%E4%BB%A3%E6%95%B0%E6%8D%AE%E9%9D%A2-Cilium-%E6%98%AF%E4%BB%80%E4%B9%88/"><meta property="article:published_time" content="2020-09-02T10:51:21+08:00"><meta property="article:modified_time" content="2020-09-02T10:51:21+08:00"><meta itemprop=name content="è¢« Google é€‰æ‹©çš„ä¸‹ä¸€ä»£æ•°æ®é¢ Cilium æ˜¯ä»€ä¹ˆ"><meta itemprop=description content="èƒŒæ™¯ åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç«  K8S ç”Ÿæ€å‘¨æŠ¥| Google é€‰æ‹© Cilium ä½œä¸º GKE ä¸‹ä¸€ä»£æ•°æ®é¢ ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»‹ç»äº† Google å®£å¸ƒä½¿ç”¨ Cilium ä½œä¸º GKE çš„ä¸‹ä¸€ä»£æ•°æ®é¢ï¼ŒåŠå…¶èƒŒåçš„æ•…äº‹ã€‚
Google é€‰æ‹© Cilium ä¸»è¦æ˜¯ä¸ºäº†å¢åŠ  GKE å¹³å°çš„å®¹å™¨å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ã€‚é‚£ä¹ˆï¼ŒCilium åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¼ºçš„å¸å¼•åŠ›å‘¢ï¼Ÿ
æ‘˜ä¸€æ®µå®˜ç½‘çš„ä»‹ç»ï¼š
 Cilium is open source software for transparently securing the network connectivity between application services deployed using Linux container management platforms like Docker and Kubernetes.
 Cilium æ˜¯ä¸€ä¸ªç”¨äºé€æ˜ä¿æŠ¤éƒ¨ç½²åœ¨ Linux å®¹å™¨ç®¡ç†å¹³å°ï¼ˆæ¯”å¦‚ Docker å’Œ Kubernetesï¼‰ä¸Šçš„åº”ç”¨æœåŠ¡ä¹‹é—´ç½‘ç»œè¿æ¥çš„å¼€æºè½¯ä»¶ã€‚
ä¸ºä»€ä¹ˆç€é‡å¼ºè°ƒæ˜¯ â€œLinux å®¹å™¨ç®¡ç†å¹³å°â€ å‘¢ï¼Ÿè¿™å°±ä¸å¾—ä¸æåˆ° Cilium çš„å®ç°äº†ã€‚Cilium çš„åŸºç¡€æ˜¯ä¸€ç§ç§°ä¸º eBPF çš„ Linux å†…æ ¸æŠ€æœ¯ï¼Œä½¿ç”¨ eBPF å¯ä»¥åœ¨ Linux è‡ªèº«å†…éƒ¨åŠ¨æ€çš„æ’å…¥ä¸€äº›æ§åˆ¶é€»è¾‘ï¼Œä»è€Œæ»¡è¶³å¯è§‚å¯Ÿæ€§å’Œå®‰å…¨æ€§ç›¸å…³çš„éœ€æ±‚ã€‚"><meta itemprop=datePublished content="2020-09-02T10:51:21+08:00"><meta itemprop=dateModified content="2020-09-02T10:51:21+08:00"><meta itemprop=wordCount content="2087"><meta itemprop=keywords content="Linux,Kubernetes,eBPF,cilium,"><meta name=twitter:card content="summary"><meta name=twitter:title content="è¢« Google é€‰æ‹©çš„ä¸‹ä¸€ä»£æ•°æ®é¢ Cilium æ˜¯ä»€ä¹ˆ"><meta name=twitter:description content="èƒŒæ™¯ åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç«  K8S ç”Ÿæ€å‘¨æŠ¥| Google é€‰æ‹© Cilium ä½œä¸º GKE ä¸‹ä¸€ä»£æ•°æ®é¢ ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»‹ç»äº† Google å®£å¸ƒä½¿ç”¨ Cilium ä½œä¸º GKE çš„ä¸‹ä¸€ä»£æ•°æ®é¢ï¼ŒåŠå…¶èƒŒåçš„æ•…äº‹ã€‚
Google é€‰æ‹© Cilium ä¸»è¦æ˜¯ä¸ºäº†å¢åŠ  GKE å¹³å°çš„å®¹å™¨å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ã€‚é‚£ä¹ˆï¼ŒCilium åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¼ºçš„å¸å¼•åŠ›å‘¢ï¼Ÿ
æ‘˜ä¸€æ®µå®˜ç½‘çš„ä»‹ç»ï¼š
 Cilium is open source software for transparently securing the network connectivity between application services deployed using Linux container management platforms like Docker and Kubernetes.
 Cilium æ˜¯ä¸€ä¸ªç”¨äºé€æ˜ä¿æŠ¤éƒ¨ç½²åœ¨ Linux å®¹å™¨ç®¡ç†å¹³å°ï¼ˆæ¯”å¦‚ Docker å’Œ Kubernetesï¼‰ä¸Šçš„åº”ç”¨æœåŠ¡ä¹‹é—´ç½‘ç»œè¿æ¥çš„å¼€æºè½¯ä»¶ã€‚
ä¸ºä»€ä¹ˆç€é‡å¼ºè°ƒæ˜¯ â€œLinux å®¹å™¨ç®¡ç†å¹³å°â€ å‘¢ï¼Ÿè¿™å°±ä¸å¾—ä¸æåˆ° Cilium çš„å®ç°äº†ã€‚Cilium çš„åŸºç¡€æ˜¯ä¸€ç§ç§°ä¸º eBPF çš„ Linux å†…æ ¸æŠ€æœ¯ï¼Œä½¿ç”¨ eBPF å¯ä»¥åœ¨ Linux è‡ªèº«å†…éƒ¨åŠ¨æ€çš„æ’å…¥ä¸€äº›æ§åˆ¶é€»è¾‘ï¼Œä»è€Œæ»¡è¶³å¯è§‚å¯Ÿæ€§å’Œå®‰å…¨æ€§ç›¸å…³çš„éœ€æ±‚ã€‚"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>MoeLove</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/about/><li class=mobile-menu-item>About</li></a><a href=/friends/><li class=mobile-menu-item>Friends</li></a><a href=/projects/><li class=mobile-menu-item>Projects</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>MoeLove</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/about/>About</a></li><li class=menu-item><a class=menu-item-link href=/friends/>Friends</a></li><li class=menu-item><a class=menu-item-link href=/projects/>Projects</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>è¢« Google é€‰æ‹©çš„ä¸‹ä¸€ä»£æ•°æ®é¢ Cilium æ˜¯ä»€ä¹ˆ</h1><div class=post-meta><span class=post-time>2020-09-02</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>æ–‡ç« ç›®å½•</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#èƒŒæ™¯>èƒŒæ™¯</a></li><li><a href=#å‡†å¤‡é›†ç¾¤>å‡†å¤‡é›†ç¾¤</a><ul><li><a href=#å†™é…ç½®æ–‡ä»¶>å†™é…ç½®æ–‡ä»¶</a></li><li><a href=#å¯åŠ¨é›†ç¾¤>å¯åŠ¨é›†ç¾¤</a></li><li><a href=#æŸ¥çœ‹çŠ¶æ€>æŸ¥çœ‹çŠ¶æ€</a></li></ul></li><li><a href=#éƒ¨ç½²-cilium>éƒ¨ç½² Cilium</a><ul><li><a href=#æ·»åŠ -helm-ä»“åº“>æ·»åŠ  Helm ä»“åº“</a></li><li><a href=#é¢„åŠ è½½é•œåƒ>é¢„åŠ è½½é•œåƒ</a></li><li><a href=#ä½¿ç”¨-helm-éƒ¨ç½²-cilium>ä½¿ç”¨ Helm éƒ¨ç½² Cilium</a></li></ul></li><li><a href=#cilium-åŠŸèƒ½ä½“éªŒ>Cilium åŠŸèƒ½ä½“éªŒ</a><ul><li><a href=#hubble-ä»‹ç»>Hubble ä»‹ç»</a></li><li><a href=#å¯è§‚å¯Ÿæ€§>å¯è§‚å¯Ÿæ€§</a></li><li><a href=#éƒ¨ç½²æµ‹è¯•åº”ç”¨>éƒ¨ç½²æµ‹è¯•åº”ç”¨</a></li><li><a href=#å‘½ä»¤è¡Œè§‚æµ‹>å‘½ä»¤è¡Œè§‚æµ‹</a></li><li><a href=#hubble-ui-è§‚æµ‹>Hubble UI è§‚æµ‹</a></li><li><a href=#hubble-metrics-è§‚æµ‹>Hubble metrics è§‚æµ‹</a></li><li><a href=#éªŒè¯-ciliumnetworkpolicy-çš„æ•ˆæœ>éªŒè¯ CiliumNetworkPolicy çš„æ•ˆæœ</a></li></ul></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ul></nav></div></div><div class=post-content><h2 id=èƒŒæ™¯>èƒŒæ™¯</h2><p>åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç«  <a href=https://zhuanlan.zhihu.com/p/195759300 title="Google é€‰æ‹© Cilium ä½œä¸º GKE ä¸‹ä¸€ä»£æ•°æ®é¢">K8S ç”Ÿæ€å‘¨æŠ¥| Google é€‰æ‹© Cilium ä½œä¸º GKE ä¸‹ä¸€ä»£æ•°æ®é¢</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»‹ç»äº† Google å®£å¸ƒä½¿ç”¨ Cilium ä½œä¸º GKE çš„ä¸‹ä¸€ä»£æ•°æ®é¢ï¼ŒåŠå…¶èƒŒåçš„æ•…äº‹ã€‚</p><p>Google é€‰æ‹© Cilium ä¸»è¦æ˜¯ä¸ºäº†å¢åŠ  GKE å¹³å°çš„å®¹å™¨å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ã€‚é‚£ä¹ˆï¼ŒCilium åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¼ºçš„å¸å¼•åŠ›å‘¢ï¼Ÿ</p><p>æ‘˜ä¸€æ®µå®˜ç½‘çš„ä»‹ç»ï¼š</p><blockquote><p>Cilium is open source software for transparently securing the network connectivity between application services deployed using Linux container management platforms like Docker and Kubernetes.</p></blockquote><p>Cilium æ˜¯ä¸€ä¸ªç”¨äºé€æ˜ä¿æŠ¤éƒ¨ç½²åœ¨ Linux å®¹å™¨ç®¡ç†å¹³å°ï¼ˆæ¯”å¦‚ Docker å’Œ Kubernetesï¼‰ä¸Šçš„åº”ç”¨æœåŠ¡ä¹‹é—´ç½‘ç»œè¿æ¥çš„å¼€æºè½¯ä»¶ã€‚</p><p>ä¸ºä»€ä¹ˆç€é‡å¼ºè°ƒæ˜¯ â€œLinux å®¹å™¨ç®¡ç†å¹³å°â€ å‘¢ï¼Ÿè¿™å°±ä¸å¾—ä¸æåˆ° Cilium çš„å®ç°äº†ã€‚Cilium çš„åŸºç¡€æ˜¯ä¸€ç§ç§°ä¸º eBPF çš„ Linux å†…æ ¸æŠ€æœ¯ï¼Œä½¿ç”¨ eBPF å¯ä»¥åœ¨ Linux è‡ªèº«å†…éƒ¨åŠ¨æ€çš„æ’å…¥ä¸€äº›æ§åˆ¶é€»è¾‘ï¼Œä»è€Œæ»¡è¶³å¯è§‚å¯Ÿæ€§å’Œå®‰å…¨æ€§ç›¸å…³çš„éœ€æ±‚ã€‚</p><p>åªè°ˆæ¦‚å¿µæ¯•ç«Ÿè¿‡äºç©ºæ´ï¼Œæœ¬èŠ‚æˆ‘ä»¬ç›´æ¥ä¸Šæ‰‹å®è·µä¸€ä¸‹ Cilium ã€‚</p><h2 id=å‡†å¤‡é›†ç¾¤>å‡†å¤‡é›†ç¾¤</h2><p>è¿™é‡Œæˆ‘ä½¿ç”¨ <a href=https://kind.sigs.k8s.io/ title="Kubernetes IN Docker">KIND</a> æ¥åˆ›å»ºä¸€å¥—å¤šèŠ‚ç‚¹çš„æœ¬åœ°é›†ç¾¤ã€‚</p><h3 id=å†™é…ç½®æ–‡ä»¶>å†™é…ç½®æ–‡ä»¶</h3><p>åœ¨åˆ›å»ºé›†ç¾¤æ—¶å€™ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶æ¥ç¦ç”¨æ‰ KIND é»˜è®¤çš„ CNI æ’ä»¶ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
- role: worker
networking:
  disableDefaultCNI: <span style=color:#66d9ef>true</span>
</code></pre></div><h3 id=å¯åŠ¨é›†ç¾¤>å¯åŠ¨é›†ç¾¤</h3><p>å°†é…ç½®æ–‡ä»¶å‘½åä¸º <code>kindconfig</code> ï¼Œé€šè¿‡ <code>--config</code> å‚æ•°æ¥æŒ‡å®šå®ƒã€‚ é€šè¿‡ <code>--image</code> å‚æ•°å¯æŒ‡å®šåˆ›å»ºé›†ç¾¤æ‰€ä½¿ç”¨çš„é•œåƒï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨ <code>kindest/node:v1.19.0@sha256:6a6e4d588db3c2873652f382465eeadc2644562a64659a1da4</code> æ¥åˆ›å»ºä¸€ä¸ªæœ€æ–°çš„ Kubernetes v1.19.0 ç‰ˆæœ¬çš„é›†ç¾¤ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kind create cluster --config<span style=color:#f92672>=</span>kindconfig  --image<span style=color:#f92672>=</span>kindest/node:v1.19.0@sha256:6a6e4d588db3c2873652f382465eeadc2644562a64659a1da4
db73d3beaa8848  
Creating cluster <span style=color:#e6db74>&#34;kind&#34;</span> ...
 âœ“ Ensuring node image <span style=color:#f92672>(</span>kindest/node:v1.19.0<span style=color:#f92672>)</span> ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing StorageClass ğŸ’¾ 
 âœ“ Joining worker nodes ğŸšœ 
Set kubectl context to <span style=color:#e6db74>&#34;kind-kind&#34;</span>
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚
</code></pre></div><h3 id=æŸ¥çœ‹çŠ¶æ€>æŸ¥çœ‹çŠ¶æ€</h3><p>ç”±äºæˆ‘ä»¬å·²ç»ç¦ç”¨äº† KIND é»˜è®¤çš„ CNI ï¼Œæ‰€ä»¥ç°åœ¨é›†ç¾¤çš„ Node éƒ½æ˜¯ <code>NotReady</code> çš„çŠ¶æ€ï¼Œç­‰å¾… CNI çš„åˆå§‹åŒ–ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl get nodes 
NAME                 STATUS     ROLES    AGE   VERSION
kind-control-plane   NotReady   master   85s   v1.19.0
kind-worker          NotReady   &lt;none&gt;   49s   v1.19.0
kind-worker2         NotReady   &lt;none&gt;   49s   v1.19.0
kind-worker3         NotReady   &lt;none&gt;   49s   v1.19.0
</code></pre></div><h2 id=éƒ¨ç½²-cilium>éƒ¨ç½² Cilium</h2><p>éƒ¨ç½² Cilium å¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©æœ€ç®€å•çš„ï¼Œç›´æ¥ä½¿ç”¨ Helm 3 è¿›è¡Œéƒ¨ç½²ã€‚</p><h3 id=æ·»åŠ -helm-ä»“åº“>æ·»åŠ  Helm ä»“åº“</h3><p>Cilium æä¾›äº†å®˜æ–¹ç»´æŠ¤çš„ Helm ä»“åº“ï¼Œæˆ‘ä»¬å…ˆæ¥æ·»åŠ å®ƒã€‚</p><p>æ³¨æ„ï¼š <strong>è¯·ä½¿ç”¨ Helm 3</strong>ã€‚ åœ¨ä¹‹å‰çš„æ–‡ç«  <a href=https://zhuanlan.zhihu.com/p/186265631 title="Helm v2 è¿›å…¥ç»´æŠ¤æœŸå€’è®¡æ—¶">K8S ç”Ÿæ€å‘¨æŠ¥| Helm v2 è¿›å…¥ç»´æŠ¤æœŸå€’è®¡æ—¶</a> ä¸­ï¼Œæˆ‘æ›¾ä»‹ç»è¿‡ Helm v2 çš„ç»´æŠ¤æœŸå·²ç»è¿›å…¥å€’è®¡æ—¶ï¼Œä¸‰ä¸ªæœˆåå°†åœæ­¢ä¸º Helm v2 æä¾›å®‰å…¨è¡¥ä¸ï¼Œå±Šæ—¶ Helm v2 çš„ç»´æŠ¤æœŸå°±å½»åº•ç»ˆæ­¢äº†ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ helm repo add cilium https://helm.cilium.io/ 
<span style=color:#e6db74>&#34;cilium&#34;</span> has been added to your repositories
</code></pre></div><h3 id=é¢„åŠ è½½é•œåƒ>é¢„åŠ è½½é•œåƒ</h3><p><strong>è¿™ä¸€æ­¥å¹¶éå¿…é¡»</strong>ã€‚ åªæ˜¯ç”±äºæ¯ä¸ªåœ¨ Node ä¸Šéƒ½éœ€è¦ä¸‹è½½ <code>cilium/cilium:v1.8.2</code> çš„é•œåƒï¼Œä¼šå¾ˆè€—æ—¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>kind load docker-image</code> å°†ä¸»æœº Docker ä¸­çš„é•œåƒåŠ è½½åˆ° KIND åˆ›å»ºçš„é›†ç¾¤ä¸­ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># ä¸‹è½½é•œåƒ</span>
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ docker pull cilium/cilium:v1.8.2 
v1.8.2: Pulling from cilium/cilium
Digest: sha256:9dffe79408025f7523a94a1828ac1691b997a2b1dbd69af338cfbecc8428d326
Status: Image is up to date <span style=color:#66d9ef>for</span> cilium/cilium:v1.8.2
docker.io/cilium/cilium:v1.8.2
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># å°†é•œåƒåŠ è½½åˆ° KIND é›†ç¾¤ä¸­</span>
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kind load docker-image cilium/cilium:v1.8.2  
Image: <span style=color:#e6db74>&#34;cilium/cilium:v1.8.2&#34;</span> with ID <span style=color:#e6db74>&#34;sha256:009715be68951ab107617f04dc50bcceb3d3f1e0c09db156aacf95e56eb0d5cc&#34;</span> not yet present on node <span style=color:#e6db74>&#34;kind-worker3&#34;</span>, loading...
Image: <span style=color:#e6db74>&#34;cilium/cilium:v1.8.2&#34;</span> with ID <span style=color:#e6db74>&#34;sha256:009715be68951ab107617f04dc50bcceb3d3f1e0c09db156aacf95e56eb0d5cc&#34;</span> not yet present on node <span style=color:#e6db74>&#34;kind-control-plane&#34;</span>, loading...
Image: <span style=color:#e6db74>&#34;cilium/cilium:v1.8.2&#34;</span> with ID <span style=color:#e6db74>&#34;sha256:009715be68951ab107617f04dc50bcceb3d3f1e0c09db156aacf95e56eb0d5cc&#34;</span> not yet present on node <span style=color:#e6db74>&#34;kind-worker&#34;</span>, loading...
Image: <span style=color:#e6db74>&#34;cilium/cilium:v1.8.2&#34;</span> with ID <span style=color:#e6db74>&#34;sha256:009715be68951ab107617f04dc50bcceb3d3f1e0c09db156aacf95e56eb0d5cc&#34;</span> not yet present on node <span style=color:#e6db74>&#34;kind-worker2&#34;</span>, loading...
</code></pre></div><p>é•œåƒåŠ è½½å®Œæˆåï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡ŒäºŒæ¬¡ç¡®è®¤ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#66d9ef>for</span> i in <span style=color:#e6db74>`</span>docker ps --filter label<span style=color:#f92672>=</span>io.x-k8s.kind.cluster<span style=color:#f92672>=</span>kind -q<span style=color:#e6db74>`</span>
<span style=color:#66d9ef>do</span>
    docker exec $i ctr -n k8s.io -a /run/containerd/containerd.sock i ls |grep cilium
<span style=color:#66d9ef>done</span>
</code></pre></div><h3 id=ä½¿ç”¨-helm-éƒ¨ç½²-cilium>ä½¿ç”¨ Helm éƒ¨ç½² Cilium</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ helm install cilium cilium/cilium --version 1.8.2 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --namespace kube-system <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.nodeinit.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.kubeProxyReplacement<span style=color:#f92672>=</span>partial <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.hostServices.enabled<span style=color:#f92672>=</span>false <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.externalIPs.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.nodePort.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.hostPort.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.pullPolicy<span style=color:#f92672>=</span>IfNotPresent <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set config.ipam<span style=color:#f92672>=</span>kubernetes <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.hubble.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.hubble.relay.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.hubble.ui.enabled<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>   --set global.hubble.metrics.enabled<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{dns,drop,tcp,flow,port-distribution,icmp,http}&#34;</span>
NAME: cilium
LAST DEPLOYED: Wed Sep  <span style=color:#ae81ff>2</span> 21:03:23 <span style=color:#ae81ff>2020</span>
NAMESPACE: kube-system
STATUS: deployed
REVISION: <span style=color:#ae81ff>1</span>
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble Relay and Hubble UI.

Your release version is 1.8.2.

For any further help, visit https://docs.cilium.io/en/v1.8/gettinghelp
</code></pre></div><p>è¿™é‡Œå¯¹å‡ ä¸ªé…ç½®é¡¹åšä¸‹è¯´æ˜ï¼š</p><ul><li><code>global.hubble.enabled=true</code> ï¼š è¡¨ç¤ºå¯ç”¨ Hubble ã€‚</li><li><code>global.hubble.metrics.enabled="{dns,drop,tcp,flow,port-distribution,icmp,http}</code>ï¼šè¡¨ç¤º Hubble æš´éœ²å‡ºçš„ metrics ä¸­åŒ…å«å“ªäº›å†…å®¹ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™è¡¨ç¤ºç¦ç”¨å®ƒã€‚</li><li><code>global.hubble.ui.enabled=true</code> ï¼šè¡¨ç¤ºå¯ç”¨ Hubble UI</li></ul><p>å¯¹äº Hubble æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬ç¨åå†ä»‹ç»ã€‚</p><p>å½“ Cilium éƒ¨ç½²å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸‹éƒ¨ç½²çš„ ns ä¸‹çš„ Pod æƒ…å†µï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl -n kube-system get pods 
NAME                                         READY   STATUS    RESTARTS   AGE
cilium-86dbc                                 1/1     Running   <span style=color:#ae81ff>0</span>          2m11s
cilium-cjcps                                 1/1     Running   <span style=color:#ae81ff>0</span>          2m11s
cilium-f8dtm                                 1/1     Running   <span style=color:#ae81ff>0</span>          2m11s
cilium-node-init-9r9cm                       1/1     Running   <span style=color:#ae81ff>1</span>          2m11s
cilium-node-init-bkg28                       1/1     Running   <span style=color:#ae81ff>1</span>          2m11s
cilium-node-init-jgx6r                       1/1     Running   <span style=color:#ae81ff>1</span>          2m11s
cilium-node-init-s7xhx                       1/1     Running   <span style=color:#ae81ff>1</span>          2m11s
cilium-operator-756cc96896-brlrh             1/1     Running   <span style=color:#ae81ff>0</span>          2m11s
cilium-t8kqc                                 1/1     Running   <span style=color:#ae81ff>0</span>          2m11s
coredns-f9fd979d6-7vfnq                      1/1     Running   <span style=color:#ae81ff>0</span>          6m16s
coredns-f9fd979d6-h7rfw                      1/1     Running   <span style=color:#ae81ff>0</span>          6m16s
etcd-kind-control-plane                      1/1     Running   <span style=color:#ae81ff>0</span>          6m19s
hubble-relay-666ddfd69b-2lpsz                1/1     Running   <span style=color:#ae81ff>0</span>          2m11s
hubble-ui-7854cf65dc-ncj89                   1/1     Running   <span style=color:#ae81ff>0</span>          2m11s
kube-apiserver-kind-control-plane            1/1     Running   <span style=color:#ae81ff>0</span>          6m19s
kube-controller-manager-kind-control-plane   1/1     Running   <span style=color:#ae81ff>0</span>          6m19s
kube-proxy-48rwk                             1/1     Running   <span style=color:#ae81ff>0</span>          6m16s
kube-proxy-8mn58                             1/1     Running   <span style=color:#ae81ff>0</span>          5m59s
kube-proxy-jptln                             1/1     Running   <span style=color:#ae81ff>0</span>          5m59s
kube-proxy-pp24h                             1/1     Running   <span style=color:#ae81ff>0</span>          5m59s
kube-scheduler-kind-control-plane            1/1     Running   <span style=color:#ae81ff>0</span>          6m19s
</code></pre></div><p>æŸ¥çœ‹ Node çš„çŠ¶æ€ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl get nodes 
NAME                 STATUS   ROLES    AGE     VERSION
kind-control-plane   Ready    master   7m1s    v1.19.0
kind-worker          Ready    &lt;none&gt;   6m26s   v1.19.0
kind-worker2         Ready    &lt;none&gt;   6m26s   v1.19.0
kind-worker3         Ready    &lt;none&gt;   6m26s   v1.19.0
</code></pre></div><h2 id=cilium-åŠŸèƒ½ä½“éªŒ>Cilium åŠŸèƒ½ä½“éªŒ</h2><h3 id=hubble-ä»‹ç»>Hubble ä»‹ç»</h3><p>ä¸Šæ–‡ä¸­ï¼Œé€šè¿‡ Helm éƒ¨ç½² Cilium æ—¶ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ä¸€äº›ä¸ Hubble æœ‰å…³çš„å‚æ•°ï¼Œä½†å°šæœªä»‹ç» Hubble å…·ä½“æ˜¯ä»€ä¹ˆã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸‹ã€‚</p><p>Hubble æ˜¯ä¸€ä¸ªå®Œå…¨åˆ†å¸ƒå¼çš„ç½‘ç»œå’Œå®‰å…¨æ€§çš„å¯è§‚å¯Ÿæ€§å¹³å°ï¼Œå®ƒå»ºç«‹åœ¨ Cilium å’Œ eBPF ä¹‹ä¸Šï¼Œä»¥å®Œå…¨é€æ˜çš„æ–¹å¼æ·±å…¥äº†è§£æœåŠ¡ä»¥åŠç½‘ç»œåŸºç¡€ç»“æ„çš„é€šä¿¡å’Œè¡Œä¸ºã€‚</p><p>ç”±äºå®ƒæ˜¯æ„å»ºåœ¨ Cilium ä¹‹ä¸Šçš„ï¼ŒHubble å¯ä»¥åˆ©ç”¨ eBPF è·å¾—å¯è§æ€§ã€‚é€šè¿‡ä½¿ç”¨ eBPF ï¼Œæ‰€æœ‰å¯è§æ€§éƒ½æ˜¯å¯ç¼–ç¨‹çš„ï¼Œå¹¶ä¸”å¯ä»¥æœ€å¤§ç¨‹åº¦çš„å‡å°‘å¼€é”€ï¼ŒåŒæ—¶æ ¹æ®ç”¨æˆ·éœ€è¦æä¾›æ·±å…¥å’Œè¯¦å°½çš„å¯è§æ€§ã€‚ä¾‹å¦‚ï¼š</p><ul><li>äº†è§£æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚å¯ä»¥è§‚æµ‹åˆ°æœåŠ¡ä¹‹é—´æ˜¯å¦æœ‰é€šä¿¡ï¼Œé€šä¿¡é¢‘ç‡ï¼Œä»¥åŠ HTTP è°ƒç”¨äº§ç”Ÿçš„çŠ¶æ€ç ç­‰ï¼›</li><li>ç›‘æ§ç½‘ç»œå’Œå‘Šè­¦ã€‚å¯ä»¥è§‚æµ‹åˆ°ç½‘ç»œè¿æ¥æ˜¯å¦å¼‚å¸¸ï¼Œæ˜¯ L4 è¿˜æ˜¯ L7 æœ‰é—®é¢˜ï¼ŒDNS æŸ¥è¯¢æ˜¯å¦å¼‚å¸¸ç­‰ï¼›</li><li>ç›‘æ§åº”ç”¨ç¨‹åºã€‚å¯ä»¥è§‚æµ‹åˆ° HTTP 4xx/5xx çš„é”™è¯¯ç‡ï¼ŒHTTP è¯·æ±‚å’Œå“åº”çš„ 95 å€¼ï¼Œ99å€¼ç­‰ï¼›</li><li>ç›‘æ§å®‰å…¨é—®é¢˜ã€‚å¯ä»¥è§‚æµ‹åˆ°å“ªäº›è¯·æ±‚æ˜¯è¢« Network Policy æ‰€æ‹’ç»çš„ï¼Œå“ªäº›æœåŠ¡è§£æäº†ç‰¹å®šçš„åŸŸåç­‰ï¼›</li></ul><h3 id=å¯è§‚å¯Ÿæ€§>å¯è§‚å¯Ÿæ€§</h3><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>hubble observe</code> è§‚æµ‹å½“å‰é›†ç¾¤ä¸­çš„è¿æ¥æƒ…å†µï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  hubble-ui git:<span style=color:#f92672>(</span>master<span style=color:#f92672>)</span> kubectl exec -n kube-system -t ds/cilium -- hubble observe
TIMESTAMP             SOURCE                                      DESTINATION                                TYPE          VERDICT     SUMMARY
Sep  <span style=color:#ae81ff>2</span> 07:06:41.624   kube-system/coredns-f9fd979d6-h7rfw:8181    10.244.1.50:52404                          to-stack      FORWARDED   TCP Flags: ACK, FIN
Sep  <span style=color:#ae81ff>2</span> 07:06:41.625   10.244.1.50:52404                           kube-system/coredns-f9fd979d6-h7rfw:8181   to-endpoint   FORWARDED   TCP Flags: ACK, FIN
Sep  <span style=color:#ae81ff>2</span> 07:06:42.376   10.244.1.12:4240                            10.244.0.76:45164                          to-overlay    FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:42.376   10.244.0.76:45164                           10.244.1.12:4240                           to-endpoint   FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:42.778   10.244.1.50:37512                           10.244.1.12:4240                           to-endpoint   FORWARDED   TCP Flags: ACK, PSH
Sep  <span style=color:#ae81ff>2</span> 07:06:42.778   10.244.1.12:4240                            10.244.1.50:37512                          to-stack      FORWARDED   TCP Flags: ACK, PSH
Sep  <span style=color:#ae81ff>2</span> 07:06:44.941   10.244.1.50:59870                           10.244.0.108:4240                          to-overlay    FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:44.941   10.244.1.12:4240                            10.244.2.220:47616                         to-overlay    FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:44.941   10.244.1.50:52090                           10.244.3.159:4240                          to-overlay    FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:44.941   10.244.1.50:52958                           10.244.2.81:4240                           to-overlay    FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:44.941   10.244.2.220:47616                          10.244.1.12:4240                           to-endpoint   FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:45.448   10.244.1.12:4240                            10.244.3.111:54012                         to-overlay    FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:45.449   10.244.3.111:54012                          10.244.1.12:4240                           to-endpoint   FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:47.631   kube-system/coredns-f9fd979d6-h7rfw:36120   172.18.0.4:6443                            to-stack      FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:47.822   10.244.1.50:60914                           kube-system/coredns-f9fd979d6-h7rfw:8080   to-endpoint   FORWARDED   TCP Fla
gs: SYN
Sep  <span style=color:#ae81ff>2</span> 07:06:47.822   kube-system/coredns-f9fd979d6-h7rfw:8080    10.244.1.50:60914                          to-stack      FORWARDED   TCP Fla
gs: SYN, ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:47.822   10.244.1.50:60914                           kube-system/coredns-f9fd979d6-h7rfw:8080   to-endpoint   FORWARDED   TCP Fla
gs: ACK
Sep  <span style=color:#ae81ff>2</span> 07:06:47.823   kube-system/coredns-f9fd979d6-h7rfw:8080    10.244.1.50:60914                          to-stack      FORWARDED   TCP Fla
gs: ACK, PSH
Sep  <span style=color:#ae81ff>2</span> 07:06:47.823   kube-system/coredns-f9fd979d6-h7rfw:8080    10.244.1.50:60914                          to-stack      FORWARDED   TCP Fla
gs: ACK, FIN
Sep  <span style=color:#ae81ff>2</span> 07:06:47.823   10.244.1.50:60914                           kube-system/coredns-f9fd979d6-h7rfw:8080   to-endpoint   FORWARDED   TCP Fla
gs: ACK, PSH
</code></pre></div><p>å¯ä»¥çœ‹åˆ°å†…å®¹å¾ˆè¯¦ç»†ï¼ŒåŒ…æ‹¬é€šä¿¡çš„ä¸¤ç«¯ï¼Œä»¥åŠå‘çš„åŒ…æ˜¯ <code>ACK</code> è¿˜æ˜¯ <code>SYN</code> ç­‰ä¿¡æ¯å‡å¯è§‚æµ‹åˆ°ã€‚</p><h3 id=éƒ¨ç½²æµ‹è¯•åº”ç”¨>éƒ¨ç½²æµ‹è¯•åº”ç”¨</h3><p>è¿™é‡Œæˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ªæµ‹è¯•åº”ç”¨æ¥å®é™…ä½“éªŒä¸‹ Cilium æä¾›çš„å¼ºå¤§åŠŸèƒ½ã€‚å®˜æ–¹ä»“åº“ä¸­æä¾›äº†ä¸€ä¸ª <a href=https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/kubernetes/connectivity-check/connectivity-check.yaml title=connectivity-check>connectivity-check</a> çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™é‡Œæˆ‘å¯¹å®ƒåšäº†ç²¾ç®€å’Œä¿®æ”¹ï¼Œä»¥ä¾¿ç†è§£ã€‚</p><p>è¿™é‡Œå®šä¹‰çš„å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>1 ä¸ªåä¸º <code>echo-a</code> çš„ svc ï¼Œç”¨äºæš´éœ² <code>echo-a</code> è¿™ä¸ªæµ‹è¯•æœåŠ¡ï¼›</li><li>4 ä¸ª deploy ï¼Œåˆ†åˆ«æ˜¯ 1 ä¸ªæµ‹è¯•æœåŠ¡ï¼Œä»¥åŠä¸‰ä¸ªç”¨äºæµ‹è¯•ä¸ <code>echo-a</code> è”é€šæ€§çš„ deploy;</li><li>2 ä¸ª CiliumNetworkPolicyï¼Œç”¨æ¥æ§åˆ¶æ˜¯å¦å…è®¸ä¸ <code>echo-a</code> è”é€šï¼›</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
apiVersion: v1
kind: Service
metadata:
  name: echo-a
spec:
  type: ClusterIP
  ports:
  - port: <span style=color:#ae81ff>80</span>
  selector:
    name: echo-a
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-a
spec:
  selector:
    matchLabels:
      name: echo-a
  replicas: <span style=color:#ae81ff>1</span>
  template:
    metadata:
      labels:
        name: echo-a
    spec:
      containers:
      - name: echo-container
        image: docker.io/cilium/json-mock:<span style=color:#ae81ff>1.0</span>
        imagePullPolicy: IfNotPresent
        readinessProbe:
          exec:
            command: [<span style=color:#e6db74>&#34;curl&#34;</span>, <span style=color:#e6db74>&#34;-sS&#34;</span>, <span style=color:#e6db74>&#34;--fail&#34;</span>, <span style=color:#e6db74>&#34;-o&#34;</span>, <span style=color:#e6db74>&#34;/dev/null&#34;</span>, <span style=color:#e6db74>&#34;localhost&#34;</span>]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pod-to-a-allowed-cnp
spec:
  selector:
    matchLabels:
      name: pod-to-a-allowed-cnp
  replicas: <span style=color:#ae81ff>1</span>
  template:
    metadata:
      labels:
        name: pod-to-a-allowed-cnp
    spec:
      containers:
      - name: pod-to-a-allowed-cnp-container
        image: docker.io/byrnedo/alpine-curl:<span style=color:#ae81ff>0.1</span><span style=color:#ae81ff>.8</span>
        command: [<span style=color:#e6db74>&#34;/bin/ash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sleep 1000000000&#34;</span>]
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command: [<span style=color:#e6db74>&#34;curl&#34;</span>, <span style=color:#e6db74>&#34;-sS&#34;</span>, <span style=color:#e6db74>&#34;--fail&#34;</span>, <span style=color:#e6db74>&#34;-o&#34;</span>, <span style=color:#e6db74>&#34;/dev/null&#34;</span>, <span style=color:#e6db74>&#34;echo-a&#34;</span>]
        readinessProbe:
          exec:
            command: [<span style=color:#e6db74>&#34;curl&#34;</span>, <span style=color:#e6db74>&#34;-sS&#34;</span>, <span style=color:#e6db74>&#34;--fail&#34;</span>, <span style=color:#e6db74>&#34;-o&#34;</span>, <span style=color:#e6db74>&#34;/dev/null&#34;</span>, <span style=color:#e6db74>&#34;echo-a&#34;</span>]
---
apiVersion: <span style=color:#e6db74>&#34;cilium.io/v2&#34;</span>
kind: CiliumNetworkPolicy
metadata:
  name: <span style=color:#e6db74>&#34;pod-to-a-allowed-cnp&#34;</span>
spec:
  endpointSelector:
    matchLabels:
      name: pod-to-a-allowed-cnp
  egress:
  - toEndpoints:
    - matchLabels:
        name: echo-a
    toPorts:
    - ports:
      - port: <span style=color:#e6db74>&#34;80&#34;</span>
        protocol: TCP
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s:k8s-app: kube-dns
    toPorts:
    - ports:
      - port: <span style=color:#e6db74>&#34;53&#34;</span>
        protocol: UDP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pod-to-a-l3-denied-cnp
spec:
  selector:
    matchLabels:
      name: pod-to-a-l3-denied-cnp
  replicas: <span style=color:#ae81ff>1</span>
  template:
    metadata:
      labels:
        name: pod-to-a-l3-denied-cnp
    spec:
      containers:
      - name: pod-to-a-l3-denied-cnp-container
        image: docker.io/byrnedo/alpine-curl:<span style=color:#ae81ff>0.1</span><span style=color:#ae81ff>.8</span>
        command: [<span style=color:#e6db74>&#34;/bin/ash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sleep 1000000000&#34;</span>]
        imagePullPolicy: IfNotPresent
        livenessProbe:
          timeoutSeconds: <span style=color:#ae81ff>7</span>
          exec:
            command: [<span style=color:#e6db74>&#34;ash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;! curl -sS --fail --connect-timeout 5 -o /dev/null echo-a&#34;</span>]
        readinessProbe:
          timeoutSeconds: <span style=color:#ae81ff>7</span>
          exec:
            command: [<span style=color:#e6db74>&#34;ash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;! curl -sS --fail --connect-timeout 5 -o /dev/null echo-a&#34;</span>]
---
apiVersion: <span style=color:#e6db74>&#34;cilium.io/v2&#34;</span>
kind: CiliumNetworkPolicy
metadata:
  name: <span style=color:#e6db74>&#34;pod-to-a-l3-denied-cnp&#34;</span>
spec:
  endpointSelector:
    matchLabels:
      name: pod-to-a-l3-denied-cnp
  egress:
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s:k8s-app: kube-dns
    toPorts:
    - ports:
      - port: <span style=color:#e6db74>&#34;53&#34;</span>
        protocol: UDP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pod-to-a
spec:
  selector:
    matchLabels:
      name: pod-to-a
  replicas: <span style=color:#ae81ff>1</span>
  template:
    metadata:
      labels:
        name: pod-to-a
    spec:
      containers:
      - name: pod-to-a-container
        image: docker.io/byrnedo/alpine-curl:<span style=color:#ae81ff>0.1</span><span style=color:#ae81ff>.8</span>
        command: [<span style=color:#e6db74>&#34;/bin/ash&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;sleep 1000000000&#34;</span>]
        imagePullPolicy: IfNotPresent
        livenessProbe:
          exec:
            command: [<span style=color:#e6db74>&#34;curl&#34;</span>, <span style=color:#e6db74>&#34;-sS&#34;</span>, <span style=color:#e6db74>&#34;--fail&#34;</span>, <span style=color:#e6db74>&#34;-o&#34;</span>, <span style=color:#e6db74>&#34;/dev/null&#34;</span>, <span style=color:#e6db74>&#34;echo-a&#34;</span>]

</code></pre></div><p>ç›´æ¥éƒ¨ç½²å³å¯ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl apply -f cilium-demo.yaml 
service/echo-a created
deployment.apps/echo-a created
deployment.apps/pod-to-a-allowed-cnp created
ciliumnetworkpolicy.cilium.io/pod-to-a-allowed-cnp created
deployment.apps/pod-to-a-l3-denied-cnp created
ciliumnetworkpolicy.cilium.io/pod-to-a-l3-denied-cnp created
deployment.apps/pod-to-a created
</code></pre></div><p>æŸ¥çœ‹ Pod çŠ¶æ€ï¼Œçœ‹çœ‹çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl get pods 
NAME                                      READY   STATUS    RESTARTS   AGE
echo-a-8b6595b89-w9kt2                    1/1     Running   <span style=color:#ae81ff>0</span>          49s
pod-to-a-5567c85856-xsg5b                 1/1     Running   <span style=color:#ae81ff>0</span>          49s
pod-to-a-allowed-cnp-7b85c8db8-jrjhx      1/1     Running   <span style=color:#ae81ff>0</span>          49s
pod-to-a-l3-denied-cnp-7f64d7b7c4-fsxrm   1/1     Running   <span style=color:#ae81ff>0</span>          49s
</code></pre></div><h3 id=å‘½ä»¤è¡Œè§‚æµ‹>å‘½ä»¤è¡Œè§‚æµ‹</h3><p>æ¥ä¸‹æ¥ï¼Œä½¿ç”¨ <code>hubble observe</code> è§‚å¯Ÿä¸‹æ•ˆæœï¼Œå·²ç»å¯ä»¥çœ‹åˆ°æˆ‘ä»¬éƒ¨ç½²çš„åº”ç”¨äº§ç”Ÿçš„è¿æ¥äº†ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl exec -n kube-system -t ds/cilium -- hubble observe  
TIMESTAMP             SOURCE                                               DESTINATION                                             TYPE          VERDICT     SUMMARY
Sep  <span style=color:#ae81ff>3</span> 00:00:13.481   default/pod-to-a-5567c85856-xsg5b:60784              default/echo-a-8b6595b89-w9kt2:80                       to-endpoint   FORWARDED   TCP Flags: ACK, PSH
Sep  <span style=color:#ae81ff>3</span> 00:00:15.429   kube-system/coredns-f9fd979d6-h7rfw:53               default/pod-to-a-allowed-cnp-7b85c8db8-jrjhx:43696      to-endpoint   FORWARDED   UDP
Sep  <span style=color:#ae81ff>3</span> 00:00:16.010   10.244.1.12:4240                                     10.244.2.220:50830                                      to-overlay    FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:16.010   10.244.1.12:4240                                     10.244.1.50:40402                                       to-stack      FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:16.010   10.244.1.50:40402                                    10.244.1.12:4240                                        to-endpoint   FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:16.011   10.244.2.220:50830                                   10.244.1.12:4240                                        to-endpoint   FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:16.523   10.244.1.12:4240                                     10.244.3.111:57242                                      to-overlay    FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:16.523   10.244.3.111:57242                                   10.244.1.12:4240                                        to-endpoint   FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:21.376   kube-system/coredns-f9fd979d6-h7rfw:53               default/pod-to-a-l3-denied-cnp-7f64d7b7c4-fsxrm:44785   to-overlay    FORWARDED   UDP
Sep  <span style=color:#ae81ff>3</span> 00:00:21.377   kube-system/coredns-f9fd979d6-h7rfw:53               default/pod-to-a-l3-denied-cnp-7f64d7b7c4-fsxrm:44785   to-overlay    FORWARDED   UDP
Sep  <span style=color:#ae81ff>3</span> 00:00:23.896   kube-system/coredns-f9fd979d6-h7rfw:36120            172.18.0.4:6443                                         to-stack      FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:25.428   default/pod-to-a-allowed-cnp-7b85c8db8-jrjhx:55678   default/echo-a-8b6595b89-w9kt2:80                       L3-L4         FORWARDED   TCP Flags: SYN
Sep  <span style=color:#ae81ff>3</span> 00:00:25.428   default/pod-to-a-allowed-cnp-7b85c8db8-jrjhx:55678   default/echo-a-8b6595b89-w9kt2:80                       to-endpoint   FORWARDED   TCP Flags: SYN
Sep  <span style=color:#ae81ff>3</span> 00:00:25.428   default/echo-a-8b6595b89-w9kt2:80                    default/pod-to-a-allowed-cnp-7b85c8db8-jrjhx:55678      to-endpoint   FORWARDED   TCP Flags: SYN, ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:25.428   default/pod-to-a-allowed-cnp-7b85c8db8-jrjhx:55678   default/echo-a-8b6595b89-w9kt2:80                       to-endpoint   FORWARDED   TCP Flags: ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:25.428   default/pod-to-a-allowed-cnp-7b85c8db8-jrjhx:55678   default/echo-a-8b6595b89-w9kt2:80                       to-endpoint   FORWARDED   TCP Flags: ACK, PSH
Sep  <span style=color:#ae81ff>3</span> 00:00:25.429   default/pod-to-a-allowed-cnp-7b85c8db8-jrjhx:55678   default/echo-a-8b6595b89-w9kt2:80                       to-endpoint   FORWARDED   TCP Flags: ACK, FIN
Sep  <span style=color:#ae81ff>3</span> 00:00:29.546   10.244.1.50:57770                                    kube-system/coredns-f9fd979d6-h7rfw:8080                to-endpoint   FORWARDED   TCP Flags: SYN
Sep  <span style=color:#ae81ff>3</span> 00:00:29.546   kube-system/coredns-f9fd979d6-h7rfw:8080             10.244.1.50:57770                                       to-stack      FORWARDED   TCP Flags: SYN, ACK
Sep  <span style=color:#ae81ff>3</span> 00:00:29.546   10.244.1.50:57770                                    kube-system/coredns-f9fd979d6-h7rfw:8080                to-endpoint   FORWARDED   TCP Flags: ACK
</code></pre></div><h3 id=hubble-ui-è§‚æµ‹>Hubble UI è§‚æµ‹</h3><p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­éƒ¨ç½² Cilium æ—¶å€™é…ç½®çš„å‡ ä¸ªå…³äº Hubble çš„å‚æ•°ä¹ˆï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Hubble UI æ¥çœ‹çœ‹æ•ˆæœã€‚</p><p>å…ˆæ£€æŸ¥ä¸‹ <code>kube-system</code> ns ä¸‹ï¼Œæ˜¯å¦æœ‰ <code>hubble-ui</code> è¿™ä¸ª svc ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  kubectl -n kube-system get svc                                                                            
NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                  AGE
hubble-metrics   ClusterIP   None           &lt;none&gt;        9091/TCP                 4m31s
hubble-relay     ClusterIP   10.102.90.19   &lt;none&gt;        80/TCP                   4m31s
hubble-ui        ClusterIP   10.96.69.234   &lt;none&gt;        80/TCP                   4m31s
kube-dns         ClusterIP   10.96.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   8m51s
</code></pre></div><p>ç›´æ¥ä½¿ç”¨ <code>kubectl port-forward</code> ï¼Œä»æœ¬åœ°æ¥è®¿é—® Hubble UI ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl -n kube-system port-forward svc/hubble-ui 12000:80
Forwarding from 127.0.0.1:12000 -&gt; <span style=color:#ae81ff>12000</span>
Forwarding from <span style=color:#f92672>[</span>::1<span style=color:#f92672>]</span>:12000 -&gt; <span style=color:#ae81ff>12000</span>
</code></pre></div><p>æµè§ˆå™¨ä¸­æ‰“å¼€ <a href=http://127.0.0.1:12000>http://127.0.0.1:12000</a> å³å¯ã€‚</p><p><img src=/img/hubble-ui.png alt="Hubble UI - https:/moelove.info"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšæ‰éƒ¨ç½²çš„æ‰€æœ‰ Podï¼Œä»¥åŠæŸ¥çœ‹åˆ°ç›¸åº”çš„ CiliumNetworkPolicy ç­‰ä¿¡æ¯ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œæ¢ç´¢ä¸‹ã€‚</p><h3 id=hubble-metrics-è§‚æµ‹>Hubble metrics è§‚æµ‹</h3><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ Hubble æš´éœ²å‡ºæ¥çš„ metrics è¿›è¡Œè§‚æµ‹ï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl port-forward -n kube-system  ds/cilium 19091:9091
Forwarding from 127.0.0.1:19091 -&gt; <span style=color:#ae81ff>9091</span>
Forwarding from <span style=color:#f92672>[</span>::1<span style=color:#f92672>]</span>:19091 -&gt; <span style=color:#ae81ff>9091</span>
</code></pre></div><p>ç®€å•çœ‹ä¸‹å…¶ä¸­çš„å†…å®¹ï¼ŒåŒ…å«å„ç±»è¯·æ±‚/å“åº”/ä¸¢å¼ƒç­‰ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œè¿˜æœ‰åŒ…æ‹¬æ¯ä¸ªç›®æ ‡ç«¯å£åŒ…çš„æ•°é‡ç»Ÿè®¡ç­‰ã€‚æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œæ¢ç´¢ä¸‹ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ curl -s localhost:19091/metrics | head -n <span style=color:#ae81ff>22</span>             
<span style=color:#75715e># HELP hubble_dns_queries_total Number of DNS queries observed</span>
<span style=color:#75715e># TYPE hubble_dns_queries_total counter</span>
hubble_dns_queries_total<span style=color:#f92672>{</span>ips_returned<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>,qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A&#34;</span>,rcode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>1165</span>
hubble_dns_queries_total<span style=color:#f92672>{</span>ips_returned<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>,qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AAAA&#34;</span>,rcode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>1165</span>
<span style=color:#75715e># HELP hubble_dns_response_types_total Number of DNS queries observed</span>
<span style=color:#75715e># TYPE hubble_dns_response_types_total counter</span>
hubble_dns_response_types_total<span style=color:#f92672>{</span>qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A&#34;</span>,type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>233</span>
hubble_dns_response_types_total<span style=color:#f92672>{</span>qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AAAA&#34;</span>,type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AAAA&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>233</span>
<span style=color:#75715e># HELP hubble_dns_responses_total Number of DNS queries observed</span>
<span style=color:#75715e># TYPE hubble_dns_responses_total counter</span>
hubble_dns_responses_total<span style=color:#f92672>{</span>ips_returned<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>,qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A&#34;</span>,rcode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Non-Existent Domain&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>932</span>
hubble_dns_responses_total<span style=color:#f92672>{</span>ips_returned<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>,qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AAAA&#34;</span>,rcode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Non-Existent Domain&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>932</span>
hubble_dns_responses_total<span style=color:#f92672>{</span>ips_returned<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span>,qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A&#34;</span>,rcode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;No Error&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>233</span>
hubble_dns_responses_total<span style=color:#f92672>{</span>ips_returned<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span>,qtypes<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AAAA&#34;</span>,rcode<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;No Error&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>233</span>
<span style=color:#75715e># HELP hubble_drop_total Number of drops</span>
<span style=color:#75715e># TYPE hubble_drop_total counter</span>
hubble_drop_total<span style=color:#f92672>{</span>protocol<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ICMPv4&#34;</span>,reason<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Policy denied&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>459</span>
hubble_drop_total<span style=color:#f92672>{</span>protocol<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ICMPv4&#34;</span>,reason<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Unsupported protocol for NAT masquerade&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>731</span>
hubble_drop_total<span style=color:#f92672>{</span>protocol<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ICMPv6&#34;</span>,reason<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Unsupported L3 protocol&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>213</span>
hubble_drop_total<span style=color:#f92672>{</span>protocol<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;TCP&#34;</span>,reason<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Policy denied&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>1425</span>
hubble_drop_total<span style=color:#f92672>{</span>protocol<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UDP&#34;</span>,reason<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Stale or unroutable IP&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>6</span>
hubble_drop_total<span style=color:#f92672>{</span>protocol<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Unknown flow&#34;</span>,reason<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Policy denied&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>1884</span>
</code></pre></div><h3 id=éªŒè¯-ciliumnetworkpolicy-çš„æ•ˆæœ>éªŒè¯ CiliumNetworkPolicy çš„æ•ˆæœ</h3><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸‹åˆšæ‰éƒ¨ç½²çš„ CiliumNetworkPolicy çš„å®é™…æ•ˆæœå§ã€‚</p><p>ä»¥ä¸‹æ˜¯åˆšæ‰éƒ¨ç½²çš„æµ‹è¯• Podï¼Œ æˆ‘ä»¬é€šè¿‡è¿™äº› Pod æ¥è®¿é—® <code>echo-a</code> è¿™ä¸ª svc ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl get pods 
NAME                                      READY   STATUS    RESTARTS   AGE
echo-a-8b6595b89-w9kt2                    1/1     Running   <span style=color:#ae81ff>0</span>          79m
pod-to-a-5567c85856-xsg5b                 1/1     Running   <span style=color:#ae81ff>0</span>          79m
pod-to-a-allowed-cnp-7b85c8db8-jrjhx      1/1     Running   <span style=color:#ae81ff>0</span>          79m
pod-to-a-l3-denied-cnp-7f64d7b7c4-fsxrm   1/1     Running   <span style=color:#ae81ff>0</span>          79m
</code></pre></div><ul><li><code>pod-to-a</code> è¿™æ˜¯æœªé…ç½®ä»»ä½• CiliumNetworkPolicy è§„åˆ™çš„ Pod</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl exec pod-to-a-5567c85856-xsg5b --  curl -sI --connect-timeout <span style=color:#ae81ff>5</span> echo-a
HTTP/1.1 <span style=color:#ae81ff>200</span> OK
X-Powered-By: Express
Vary: Origin, Accept-Encoding
Access-Control-Allow-Credentials: true
Accept-Ranges: bytes
Cache-Control: public, max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
Last-Modified: Sat, <span style=color:#ae81ff>26</span> Oct <span style=color:#ae81ff>1985</span> 08:15:00 GMT
ETag: W/<span style=color:#e6db74>&#34;83d-7438674ba0&#34;</span>
Content-Type: text/html; charset<span style=color:#f92672>=</span>UTF-8
Content-Length: <span style=color:#ae81ff>2109</span>
Date: Thu, <span style=color:#ae81ff>03</span> Sep <span style=color:#ae81ff>2020</span> 00:54:05 GMT
Connection: keep-alive

</code></pre></div><ul><li><code>pod-to-a-allowed-cnp</code> é…ç½®äº†å…è®¸é€šè¿‡ <code>TCP</code> è®¿é—® <code>echo-a</code></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl exec pod-to-a-allowed-cnp-7b85c8db8-jrjhx --  curl -sI --connect-timeout <span style=color:#ae81ff>5</span> echo-a
HTTP/1.1 <span style=color:#ae81ff>200</span> OK
X-Powered-By: Express
Vary: Origin, Accept-Encoding
Access-Control-Allow-Credentials: true
Accept-Ranges: bytes
Cache-Control: public, max-age<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
Last-Modified: Sat, <span style=color:#ae81ff>26</span> Oct <span style=color:#ae81ff>1985</span> 08:15:00 GMT
ETag: W/<span style=color:#e6db74>&#34;83d-7438674ba0&#34;</span>
Content-Type: text/html; charset<span style=color:#f92672>=</span>UTF-8
Content-Length: <span style=color:#ae81ff>2109</span>
Date: Thu, <span style=color:#ae81ff>03</span> Sep <span style=color:#ae81ff>2020</span> 01:10:27 GMT
Connection: keep-alive

</code></pre></div><ul><li><code>pod-to-a-l3-denied-cnp</code> åˆ™æ˜¯åªé…ç½®äº†å…è®¸è®¿é—® DNSï¼Œè€Œæœªé…ç½®å…è®¸å¯¹ <code>echo-a</code> çš„è®¿é—®</li></ul><pre><code>(MoeLove) âœ  ~ kubectl exec pod-to-a-l3-denied-cnp-7f64d7b7c4-fsxrm --  curl -sI --connect-timeout 5 echo-a
command terminated with exit code 28
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœå¯¹ Pod åº”ç”¨äº† CiliumNetworkPolicy , ä½†æ˜¯æœªé…ç½®å¯¹åº”çš„å…è®¸è§„åˆ™çš„è¯ï¼Œåˆ™ä»£è¡¨ä¸å…è®¸è®¿é—®ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šé¢ä¸¤ä¸ªé…ç½®äº† CiliumNetworkPolicy çš„ Pod æ¥è®¿é—®ä¸‹å…¬ç½‘åŸŸåï¼š</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl exec pod-to-a-allowed-cnp-7b85c8db8-jrjhx --  curl -sI --connect-timeout <span style=color:#ae81ff>5</span> moelove.info
command terminated with exit code <span style=color:#ae81ff>28</span>
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> âœ  ~ kubectl exec pod-to-a-l3-denied-cnp-7f64d7b7c4-fsxrm --  curl -sI --connect-timeout <span style=color:#ae81ff>5</span> moelove.info
command terminated with exit code <span style=color:#ae81ff>28</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå‡ä¸èƒ½æ­£å¸¸è®¿é—®ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“</h2><p>æœ¬èŠ‚ï¼Œä¸»è¦ä»‹ç»äº† Cilium å’Œ Hubble ç­‰ã€‚</p><p>é€šè¿‡ä½¿ç”¨ KIND åˆ›å»ºçš„ Kubernetes é›†ç¾¤ï¼Œéƒ¨ç½²äº† Cilium åŠå…¶ç›¸å…³ç»„ä»¶ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®ä¾‹ï¼Œæ¥å±•ç¤ºäº†é€šè¿‡ <code>hubble observe</code>ï¼ŒHubble UI åŠ Hubble metrics ç­‰æ–¹å¼è¿›è¡Œè§‚æµ‹ã€‚</p><p>ä¹Ÿé€šè¿‡å®é™…æ“ä½œï¼ŒéªŒè¯äº† CiliumNetworkPolicy çš„å®é™…æ•ˆæœã€‚</p><p>æˆ‘ä¸»è¦æ˜¯åœ¨ä¸º Docker å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠåˆ° <code>LSM</code> åŠ <code>seccomp</code> ç­‰éƒ¨åˆ†ï¼Œæ‰€ä»¥é¡ºä¾¿å»ç ”ç©¶äº† eBPF åŠå…¶ç›¸å…³æŠ€æœ¯ï¼ˆåç»­å†åˆ†äº«è¿™éƒ¨åˆ†å†…å®¹ï¼‰ã€‚</p><p>è€Œ Cilium åˆ™æ˜¯æˆ‘åœ¨ 2019 å¹´ä¸ŠåŠå¹´å¼€å§‹å­¦ä¹ å’Œç ”ç©¶çš„ï¼Œä½†æ­£å¦‚æˆ‘åœ¨å»å¹´çš„æ–‡ç«  <a href=https://zhuanlan.zhihu.com/p/79757835 title="K8S ç”Ÿæ€å‘¨æŠ¥| cilium 1.6 å‘å¸ƒ 100% kube-proxy çš„æ›¿ä»£å“">ã€ŠK8S ç”Ÿæ€å‘¨æŠ¥| cilium 1.6 å‘å¸ƒ 100% kube-proxy çš„æ›¿ä»£å“ã€‹</a> ä¸­å†™çš„é‚£æ ·ï¼š</p><blockquote><p>è¿™é‡Œç¨å¾®è¯´å‡ å¥æˆ‘å…³äº Cilium çš„çœ‹æ³•ï¼š</p><ul><li>å‰ä¸å‰å®³ï¼Ÿå‰å®³ã€‚</li><li>å€¼ä¸å€¼å¾—ç ”ç©¶ï¼Ÿå€¼å¾—ã€‚</li><li>ä¼šä¸ä¼šæ”¾åˆ°è‡ªå·±çš„é›†ç¾¤æ›¿ä»£ kube-proxy ï¼Ÿä¸ä¼šï¼Œæœ€èµ·ç ç›®å‰ä¸ä¼šã€‚</li></ul><p>å¦‚æœä½ æƒ³è¦é€šè¿‡ cilium ç ”ç©¶ eBPF æˆ–è€… XDP æˆ‘å€’æ˜¯å»ºè®®ä½ å¯ä»¥çœ‹çœ‹ï¼Œæ˜¯ä¸ªå¾ˆä¸é”™çš„é¡¹ç›®ï¼Œè€Œä¸”é€šè¿‡è¿™ä¸ªé¡¹ç›®èƒ½åŠ æ·±å¾ˆå¤šç½‘ç»œæ–¹é¢çš„è®¤è¯†ã€‚è¿™ä¹ˆè¯´å§ï¼Œå¦‚æœæŠŠ cilium çš„æºç åŠæ‰€æ¶‰åŠåŸç†éƒ½ç ”ç©¶é€šé€äº†ï¼Œé‚£å°±å¾ˆå‰å®³äº†ã€‚</p><p>è‡³äºè¦ä¸è¦æ›¿æ¢ kube-proxy åœ¨æˆ‘çœ‹æ¥ï¼Œæœ€èµ·ç ç›®å‰æˆ‘ä¸ä¼šè¿™æ ·å»åšã€‚è§£å†³é—®é¢˜çš„åŠæ³•æœ‰å¾ˆå¤šç§ï¼Œè€Œæ›¿æ¢æ‰ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œå´ä¸ä¸€å®šæ˜¯ä¸€ä¸ªæœ€å€¼å¾—çš„é€‰æ‹©ã€‚</p></blockquote><p>Cilium æ˜¯ä¸€ä¸ªå€¼å¾—å­¦ä¹ å’Œç ”ç©¶çš„é¡¹ç›®/æŠ€æœ¯ï¼Œä½†æˆ‘ç›®å‰å°šæœªå°†å®ƒæ”¾åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼ˆè¿™ä¹Ÿæ˜¯æˆ‘å°‘æ•°èŠ±è´¹å¾ˆå¤šç²¾åŠ›ç ”ç©¶ï¼Œä½†æœªåº”ç”¨äºç”Ÿäº§çš„æŠ€æœ¯ä¹‹ä¸€ï¼‰ã€‚</p><p>ä½†ç°åœ¨çœ‹æ¥ï¼Œ Cilium ä¹Ÿæœ‰äº†ä¸€å®šçš„å¸‚åœº/å‘å±•ï¼Œæ˜¯æ—¶å€™é‡æ–°è€ƒé‡ä¸‹äº†ã€‚åç»­æˆ‘ä¼šç»§ç»­åˆ†äº« Cilium åŠ eBPF ç›¸å…³çš„æŠ€æœ¯æ–‡ç« ï¼Œæ¬¢è¿å…³æ³¨ã€‚</p><p><img src=https://raw.githubusercontent.com/tao12345666333/collection/master/images/my_qrcode.jpg alt=TheMoeLove></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>æ–‡ç« ä½œè€…</span>
<span class=item-content>å¼ æ™‹æ¶›</span></p><p class=copyright-item><span class=item-title>ä¸Šæ¬¡æ›´æ–°</span>
<span class=item-content>2020-09-02</span></p><p class=copyright-item><span class=item-title>è®¸å¯åè®®</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank>CC BY-SA 4.0</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>èµèµæ”¯æŒ</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://raw.githubusercontent.com/tao12345666333/collection/master/images/wx_pay.jpg>
<span>å¾®ä¿¡æ‰“èµ</span></label>
<label class=qr-code-image for=reward><img class=image src=https://raw.githubusercontent.com/tao12345666333/collection/master/images/alipay.jpg>
<span>æ”¯ä»˜å®æ‰“èµ</span></label></div></div><footer class=post-footer><div class=post-tags><a href=/tags/linux/>Linux</a>
<a href=/tags/kubernetes/>Kubernetes</a>
<a href=/tags/ebpf/>eBPF</a>
<a href=/tags/cilium/>cilium</a></div><nav class=post-nav><a class=prev href=/2020/09/05/K8S-%E7%94%9F%E6%80%81%E5%91%A8%E6%8A%A5-%E6%98%AF%E6%97%B6%E5%80%99%E4%BB%8E-k8s-v1.16-%E5%8D%87%E7%BA%A7%E4%BA%86/><i class="iconfont icon-left"></i><span class="prev-text nav-default">K8S ç”Ÿæ€å‘¨æŠ¥| æ˜¯æ—¶å€™ä» k8s v1.16 å‡çº§äº†</span>
<span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span></a>
<a class=next href=/2020/08/28/K8S-%E7%94%9F%E6%80%81%E5%91%A8%E6%8A%A5-Kubernetes-v1.19-%E6%AD%A3%E5%BC%8F%E5%8F%91%E5%B8%83/><span class="next-text nav-default">K8S ç”Ÿæ€å‘¨æŠ¥| Kubernetes v1.19 æ­£å¼å‘å¸ƒ</span>
<span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js crossorigin=anonymous></script><script type=text/javascript>var gitalk=new Gitalk({id:'2020-09-02 10:51:21 \x2b0800 CST',title:'è¢« Google é€‰æ‹©çš„ä¸‹ä¸€ä»£æ•°æ®é¢ Cilium æ˜¯ä»€ä¹ˆ',clientID:'68312db64e870efbd0a0',clientSecret:'a062c51a15de76546aa52351e0dd5b3cfb0cc7d8',repo:'tao12345666333.github.io',owner:'tao12345666333',admin:['tao12345666333'],body:decodeURI(location.href)});gitalk.render('gitalk-container');</script><noscript>Please enable JavaScript to view the <a href=https://github.com/gitalk/gitalk>comments powered by gitalk.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:zhangjintao9020@gmail.com class="iconfont icon-email" title=email></a><a href=https://twitter.com/BeierTao class="iconfont icon-twitter" title=twitter></a><a href=https://github.com/tao12345666333 class="iconfont icon-github" title=github></a><a href=http://weibo.com/9020taobeier class="iconfont icon-weibo" title=weibo></a><a href=https://www.zhihu.com/people/TaoBeier class="iconfont icon-zhihu" title=zhihu></a><a href=https://moelove.info/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>ç”± <a class=hexo-link href=https://gohugo.io>Hugo</a> å¼ºåŠ›é©±åŠ¨</span>
<span class=division>|</span>
<span class=theme-info>ä¸»é¢˜ -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2013 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>å¼ æ™‹æ¶›</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/lib/fancybox/jquery.fancybox-3.1.20.min.js></script><script type=text/javascript src=/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js></script></body></html>