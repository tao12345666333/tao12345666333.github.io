<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>初试 Open Service Mesh（OSM） - MoeLove</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-1876963677156202",enable_page_level_ads:true});</script><meta name=author content="张晋涛"><meta name=description content="微软近期开源了一个新的名为 Open Service Mesh 的项目并准备捐赠给 CNCF 。
基本介绍  Open Service Mesh (OSM) is a lightweight, extensible, Cloud Native service mesh that allows users to uniformly manage, secure, and get out-of-the-box observability features for highly dynamic microservice environments.
 Open Service Mesh（OSM）是一个轻量级，可扩展的云原生服务网格，它使用户能够统一管理，保护和获得针对高度动态微服务环境的开箱即用的可观察性功能。
OSM 在 Kubernetes 上运行基于 Envoy 的控制平面，可以使用 SMI API 进行配置。它通过以 sidecar 的形式注入 Envoy 代理来工作。
控制面负责持续配置代理，以配置策略和路由规则等都保持最新。代理主要负责执行访问控制的规则，路由控制，采集 metrics 等。（这和目前我们常见到的 Service Mesh 方案基本都一样的）
显著特性  基于 Service Mesh Interface (SMI) 的实现，主要包括 Traffic Access Control， Traffic Specs 和 Traffic Split 。剩下的 Traffic Metrics 正在开发中； 服务间的通信加密使用 mTLS ； 定义和执行服务间的访问控制策略； 通过 Prometheus 和 Grafana 完成其观察性； 可与外部证书管理服务进行集成； Envoy sidecar  自动注入；  上手体验 只做介绍未免太过无趣，而且说实话，这么多 service mesh 实现，不亲自上手试试看，感觉不出来太多差异的。"><meta name=keywords content="MoeLove,Linux,Docker,Kubernetes,Golang,Python,Container,Vim,容器,k8s"><meta name=baidu-site-verification content="jO2rMlnjJi"><meta name=google-site-verification content="googlefe3fc086c62f7210.html"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=https://moelove.info/2020/08/07/%E5%88%9D%E8%AF%95-Open-Service-MeshOSM/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.8c3cbcb0324c2bb4875ceccba4007cbad4b4ac8377f33af9953c3e7684534a50.css rel=stylesheet><link href=/lib/fancybox/jquery.fancybox-3.1.20.min.css rel=stylesheet><meta property="og:title" content="初试 Open Service Mesh（OSM）"><meta property="og:description" content="微软近期开源了一个新的名为 Open Service Mesh 的项目并准备捐赠给 CNCF 。
基本介绍  Open Service Mesh (OSM) is a lightweight, extensible, Cloud Native service mesh that allows users to uniformly manage, secure, and get out-of-the-box observability features for highly dynamic microservice environments.
 Open Service Mesh（OSM）是一个轻量级，可扩展的云原生服务网格，它使用户能够统一管理，保护和获得针对高度动态微服务环境的开箱即用的可观察性功能。
OSM 在 Kubernetes 上运行基于 Envoy 的控制平面，可以使用 SMI API 进行配置。它通过以 sidecar 的形式注入 Envoy 代理来工作。
控制面负责持续配置代理，以配置策略和路由规则等都保持最新。代理主要负责执行访问控制的规则，路由控制，采集 metrics 等。（这和目前我们常见到的 Service Mesh 方案基本都一样的）
显著特性  基于 Service Mesh Interface (SMI) 的实现，主要包括 Traffic Access Control， Traffic Specs 和 Traffic Split 。剩下的 Traffic Metrics 正在开发中； 服务间的通信加密使用 mTLS ； 定义和执行服务间的访问控制策略； 通过 Prometheus 和 Grafana 完成其观察性； 可与外部证书管理服务进行集成； Envoy sidecar  自动注入；  上手体验 只做介绍未免太过无趣，而且说实话，这么多 service mesh 实现，不亲自上手试试看，感觉不出来太多差异的。"><meta property="og:type" content="article"><meta property="og:url" content="https://moelove.info/2020/08/07/%E5%88%9D%E8%AF%95-Open-Service-MeshOSM/"><meta property="article:published_time" content="2020-08-07T00:19:13+08:00"><meta property="article:modified_time" content="2020-08-07T00:19:13+08:00"><meta itemprop=name content="初试 Open Service Mesh（OSM）"><meta itemprop=description content="微软近期开源了一个新的名为 Open Service Mesh 的项目并准备捐赠给 CNCF 。
基本介绍  Open Service Mesh (OSM) is a lightweight, extensible, Cloud Native service mesh that allows users to uniformly manage, secure, and get out-of-the-box observability features for highly dynamic microservice environments.
 Open Service Mesh（OSM）是一个轻量级，可扩展的云原生服务网格，它使用户能够统一管理，保护和获得针对高度动态微服务环境的开箱即用的可观察性功能。
OSM 在 Kubernetes 上运行基于 Envoy 的控制平面，可以使用 SMI API 进行配置。它通过以 sidecar 的形式注入 Envoy 代理来工作。
控制面负责持续配置代理，以配置策略和路由规则等都保持最新。代理主要负责执行访问控制的规则，路由控制，采集 metrics 等。（这和目前我们常见到的 Service Mesh 方案基本都一样的）
显著特性  基于 Service Mesh Interface (SMI) 的实现，主要包括 Traffic Access Control， Traffic Specs 和 Traffic Split 。剩下的 Traffic Metrics 正在开发中； 服务间的通信加密使用 mTLS ； 定义和执行服务间的访问控制策略； 通过 Prometheus 和 Grafana 完成其观察性； 可与外部证书管理服务进行集成； Envoy sidecar  自动注入；  上手体验 只做介绍未免太过无趣，而且说实话，这么多 service mesh 实现，不亲自上手试试看，感觉不出来太多差异的。"><meta itemprop=datePublished content="2020-08-07T00:19:13+08:00"><meta itemprop=dateModified content="2020-08-07T00:19:13+08:00"><meta itemprop=wordCount content="786"><meta itemprop=keywords content="Kubernetes,Istio,servicemesh,"><meta name=twitter:card content="summary"><meta name=twitter:title content="初试 Open Service Mesh（OSM）"><meta name=twitter:description content="微软近期开源了一个新的名为 Open Service Mesh 的项目并准备捐赠给 CNCF 。
基本介绍  Open Service Mesh (OSM) is a lightweight, extensible, Cloud Native service mesh that allows users to uniformly manage, secure, and get out-of-the-box observability features for highly dynamic microservice environments.
 Open Service Mesh（OSM）是一个轻量级，可扩展的云原生服务网格，它使用户能够统一管理，保护和获得针对高度动态微服务环境的开箱即用的可观察性功能。
OSM 在 Kubernetes 上运行基于 Envoy 的控制平面，可以使用 SMI API 进行配置。它通过以 sidecar 的形式注入 Envoy 代理来工作。
控制面负责持续配置代理，以配置策略和路由规则等都保持最新。代理主要负责执行访问控制的规则，路由控制，采集 metrics 等。（这和目前我们常见到的 Service Mesh 方案基本都一样的）
显著特性  基于 Service Mesh Interface (SMI) 的实现，主要包括 Traffic Access Control， Traffic Specs 和 Traffic Split 。剩下的 Traffic Metrics 正在开发中； 服务间的通信加密使用 mTLS ； 定义和执行服务间的访问控制策略； 通过 Prometheus 和 Grafana 完成其观察性； 可与外部证书管理服务进行集成； Envoy sidecar  自动注入；  上手体验 只做介绍未免太过无趣，而且说实话，这么多 service mesh 实现，不亲自上手试试看，感觉不出来太多差异的。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>MoeLove</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/about/><li class=mobile-menu-item>About</li></a><a href=/friends/><li class=mobile-menu-item>Friends</li></a><a href=/projects/><li class=mobile-menu-item>Projects</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>MoeLove</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/about/>About</a></li><li class=menu-item><a class=menu-item-link href=/friends/>Friends</a></li><li class=menu-item><a class=menu-item-link href=/projects/>Projects</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>初试 Open Service Mesh（OSM）</h1><div class=post-meta><span class=post-time>2020-08-07</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>文章目录</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#基本介绍>基本介绍</a></li><li><a href=#显著特性>显著特性</a></li><li><a href=#上手体验>上手体验</a><ul><li><a href=#安装>安装</a></li></ul></li><li><a href=#实践>实践</a></li><li><a href=#dashboard>Dashboard</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=post-content><p>微软近期开源了一个新的名为 <a href=https://github.com/openservicemesh/osm/ title=OSM>Open Service Mesh</a> 的项目并准备<a href=https://github.com/cncf/toc/pull/507 title=捐赠提案>捐赠给 CNCF</a> 。</p><h2 id=基本介绍>基本介绍</h2><blockquote><p>Open Service Mesh (OSM) is a lightweight, extensible, Cloud Native service mesh that allows users to uniformly manage, secure, and get out-of-the-box observability features for highly dynamic microservice environments.</p></blockquote><p>Open Service Mesh（OSM）是一个轻量级，可扩展的云原生服务网格，它使用户能够统一管理，保护和获得针对高度动态微服务环境的开箱即用的可观察性功能。</p><p>OSM 在 Kubernetes 上运行基于 Envoy 的控制平面，可以使用 SMI API 进行配置。它通过以 sidecar 的形式注入 Envoy 代理来工作。</p><p>控制面负责持续配置代理，以配置策略和路由规则等都保持最新。代理主要负责执行访问控制的规则，路由控制，采集 metrics 等。（这和目前我们常见到的 Service Mesh 方案基本都一样的）</p><h2 id=显著特性>显著特性</h2><ul><li>基于 Service Mesh Interface (SMI) 的实现，主要包括 <code>Traffic Access Control</code>， <code>Traffic Specs</code> 和 <code>Traffic Split</code> 。剩下的 <code>Traffic Metrics</code> 正在开发中；</li><li>服务间的通信加密使用 mTLS ；</li><li>定义和执行服务间的<a href=https://github.com/servicemeshinterface/smi-spec/blob/v0.5.0/apis/traffic-access/v1alpha2/traffic-access.md title=访问控制>访问控制</a>策略；</li><li>通过 Prometheus 和 Grafana 完成其观察性；</li><li>可与外部证书管理服务进行集成；</li><li><a href=https://github.com/openservicemesh/osm/blob/main/docs/patterns/sidecar_injection.md title="sidecar 注入">Envoy sidecar</a> 自动注入；</li></ul><h2 id=上手体验>上手体验</h2><p>只做介绍未免太过无趣，而且说实话，这么多 service mesh 实现，不亲自上手试试看，感觉不出来太多差异的。</p><p>这里我使用 <a href=https://kind.sigs.k8s.io/ title="Kubernetes In Docker">KIND</a> 作为我本地的实验环境。</p><h3 id=安装>安装</h3><p>安装过程很简单，直接去 <a href=https://github.com/openservicemesh/osm/releases title="osm Release 页面">Release 页面</a> 下载预编译好的二进制文件。可将二进制文件加入到 <code>$PATH</code> 中。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ wget -q https://github.com/openservicemesh/osm/releases/download/v0.1.0/osm-v0.1.0-linux-amd64.tar.gz
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ tar -xzvf osm-v0.1.0-linux-amd64.tar.gz           
linux-amd64/
linux-amd64/LICENSE
linux-amd64/README.md
linux-amd64/osm
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ cd linux-amd64 
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  linux-amd64 ls
LICENSE  osm  README.md
</code></pre></div><p>在进行 osm 资源和服务的正式安装前，先做个必要的检查：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  linux-amd64 ./osm check --pre-install                                                                       
ok: initialize Kubernetes client
ok: query Kubernetes API
ok: Kubernetes version
ok: can create namespaces
ok: can create customresourcedefinitions
ok: can create clusterroles
ok: can create clusterrolebindings
ok: can create mutatingwebhookconfigurations
ok: can create serviceaccounts
ok: can create services
ok: can create deployments
ok: can create configmaps
ok: can read secrets
ok: can modify iptables
All checks successful!
</code></pre></div><p>可以看到主要是和权限相关的一些检查。接下来就正式对 ocm 相关资源进行部署。</p><p>默认使用的镜像，托管在 DockerHub 上，如果需要配置加速的小伙伴，可传递 <code>--container-registry</code> 更改源地址，以便于加速安装进度。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  linux-amd64 ./osm install

OSM installed successfully in namespace <span style=color:#f92672>[</span>osm-system<span style=color:#f92672>]</span> with mesh name <span style=color:#f92672>[</span>osm<span style=color:#f92672>]</span>
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  linux-amd64 kubectl -n osm-system get pods
NAME                              READY   STATUS              RESTARTS   AGE
osm-controller-d499d6cc7-88659    0/1     ContainerCreating   <span style=color:#ae81ff>0</span>          12s
osm-grafana-58ff65dfb7-svztv      0/1     ContainerCreating   <span style=color:#ae81ff>0</span>          12s
osm-prometheus-5756769877-zj6f6   0/1     ContainerCreating   <span style=color:#ae81ff>0</span>          12s
zipkin-6df4b57677-dcq8q           0/1     ContainerCreating   <span style=color:#ae81ff>0</span>          12s 
</code></pre></div><p>可以看到默认安装完成后，都在 <code>osm-system</code> 命名空间下，有 4 个 Pods</p><ul><li>osm-controller：控制谬</li><li>osm-grafana：Dashboard 相关，可通过 <code>osm dashboard</code> 命令唤起；</li><li>osm-prometheus：采集 metrics ；</li><li>zipkin：链路追踪</li></ul><p>还有对应的 service 记录.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  linux-amd64 kubectl -n osm-system get svc  
NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>             AGE
osm-controller   ClusterIP   10.97.115.1      &lt;none&gt;        15128/TCP,443/TCP   7m46s
osm-grafana      ClusterIP   10.110.209.86    &lt;none&gt;        3000/TCP            7m46s
osm-prometheus   ClusterIP   10.97.10.65      &lt;none&gt;        7070/TCP            7m46s
zipkin           ClusterIP   10.103.150.158   &lt;none&gt;        9411/TCP            7m46s
</code></pre></div><p>以及一系列的 CRD</p><pre><code>(MoeLove) ➜  linux-amd64 kubectl -n osm-system get crd   
NAME                                      CREATED AT
backpressures.policy.openservicemesh.io   2020-08-06T16:14:03Z
httproutegroups.specs.smi-spec.io         2020-08-06T16:14:03Z
tcproutes.specs.smi-spec.io               2020-08-06T16:14:03Z
trafficsplits.split.smi-spec.io           2020-08-06T16:14:03Z
traffictargets.access.smi-spec.io         2020-08-06T16:14:03Z
</code></pre><h2 id=实践>实践</h2><ul><li>创建实验用的 namespace, 并通过 <code>osm namespace add</code> 将其纳入管理范围中：</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ kubectl create ns bookstore
namespace/bookstore created
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ kubectl create ns bookbuyer
namespace/bookbuyer created
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ kubectl create ns bookthief
namespace/bookthief created
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ kubectl create ns bookwarehouse
namespace/bookwarehouse created
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  ~ osm namespace add bookstore bookbuyer bookthief bookwarehouse
Namespace <span style=color:#f92672>[</span>bookstore<span style=color:#f92672>]</span> succesfully added to mesh <span style=color:#f92672>[</span>osm<span style=color:#f92672>]</span>
Namespace <span style=color:#f92672>[</span>bookbuyer<span style=color:#f92672>]</span> succesfully added to mesh <span style=color:#f92672>[</span>osm<span style=color:#f92672>]</span>
Namespace <span style=color:#f92672>[</span>bookthief<span style=color:#f92672>]</span> succesfully added to mesh <span style=color:#f92672>[</span>osm<span style=color:#f92672>]</span>
Namespace <span style=color:#f92672>[</span>bookwarehouse<span style=color:#f92672>]</span> succesfully added to mesh <span style=color:#f92672>[</span>osm<span style=color:#f92672>]</span>
</code></pre></div><ul><li>部署实验应用程序</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># 在项目的代码目录中执行</span>
<span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  osm git:<span style=color:#f92672>(</span>main<span style=color:#f92672>)</span> kubectl apply -f docs/example/manifests/apps 
Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply
namespace/bookbuyer configured
serviceaccount/bookbuyer created
service/bookbuyer created
deployment.apps/bookbuyer created
Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply
namespace/bookstore configured
service/bookstore created
service/bookstore-v1 created
serviceaccount/bookstore-v1 created
deployment.apps/bookstore-v1 created
Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply
namespace/bookthief configured
serviceaccount/bookthief created
service/bookthief created
deployment.apps/bookthief created
Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply
namespace/bookwarehouse configured
serviceaccount/bookwarehouse created
service/bookwarehouse created
deployment.apps/bookwarehouse created
trafficsplit.split.smi-spec.io/bookstore-split created
</code></pre></div><ul><li>本地访问</li></ul><p>你可以通过 <code>kubectl port-foward</code> 在本地对刚才部署的应用进行访问。示例中也提供了相应的启动脚本 <code>scripts/port-forward-all.sh</code> ，注意这里需要先安装 GNU parallel ，例如： <code>dnf install parallel</code> .</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#f92672>(</span>MoeLove<span style=color:#f92672>)</span> ➜  osm git:<span style=color:#f92672>(</span>main<span style=color:#f92672>)</span> ✗ ./scripts/port-forward-all.sh
Academic tradition requires you to cite works you base your article on.
If you use programs that use GNU Parallel to process data <span style=color:#66d9ef>for</span> an article in a
scientific publication, please cite:

  O. Tange <span style=color:#f92672>(</span>2018<span style=color:#f92672>)</span>: GNU Parallel 2018, Mar 2018, ISBN 9781387509881,
  DOI https://doi.org/10.5281/zenodo.1146014

This helps funding further development; AND IT WON<span style=color:#e6db74>&#39;T COST YOU A CENT.
</span><span style=color:#e6db74>If you pay 10000 EUR you should feel free to use GNU Parallel without citing.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>More about funding GNU Parallel and the citation notice:
</span><span style=color:#e6db74>https://www.gnu.org/software/parallel/parallel_design.html#Citation-notice
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>To silence this citation notice: run &#39;</span>parallel --citation<span style=color:#960050;background-color:#1e0010>&#39;</span> once.


</code></pre></div><p>访问本地的 <code>8080~8083</code> 端口即可看到示例项目。例如：</p><p><img src=/img/osm-bookbuyer.png alt></p><p><em>备注：这里是因为我的应用程序已经运行一段时间了，如果是新部署的，所有数字皆为 0</em></p><ul><li>访问控制策略</li></ul><p>我们来看看如何调整访问控制的策略</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>kind: TrafficTarget
apiVersion: access.smi-spec.io/v1alpha2
metadata:
  name: bookstore-v1
  namespace: bookstore
spec:
  destination:
    kind: ServiceAccount
    name: bookstore-v1
    namespace: bookstore
  rules:
  - kind: HTTPRouteGroup
    name: bookstore-service-routes
    matches:
    - buy-a-book
    - books-bought
  sources:
  - kind: ServiceAccount
    name: bookbuyer
    namespace: bookbuyer
  <span style=color:#75715e>#- kind: ServiceAccount</span>
    <span style=color:#75715e>#name: bookthief</span>
    <span style=color:#75715e>#namespace: bookthief</span>
---
apiVersion: specs.smi-spec.io/v1alpha3
kind: HTTPRouteGroup
metadata:
  name: bookstore-service-routes
  namespace: bookstore
spec:
  matches:
  - name: books-bought
    pathRegex: /books-bought
    methods:
    - GET
    headers:
    - host: <span style=color:#e6db74>&#34;bookstore.bookstore&#34;</span>
    - <span style=color:#e6db74>&#34;user-agent&#34;</span>: <span style=color:#e6db74>&#34;.*-http-client/*.*&#34;</span>
    - <span style=color:#e6db74>&#34;client-app&#34;</span>: <span style=color:#e6db74>&#34;bookbuyer&#34;</span>
  - name: buy-a-book
    pathRegex: <span style=color:#e6db74>&#34;.*a-book.*new&#34;</span>
    methods:
    - GET
    headers:
    - host: <span style=color:#e6db74>&#34;bookstore.bookstore&#34;</span>

</code></pre></div><p>这里定义了两个 SMI 中的资源 <code>TrafficTarget</code> 和 <code>HTTPRouteGroup</code> ，用来控制入口流量。</p><pre><code>(MoeLove) ➜  osm git:(main) ✗ kubectl apply -f docs/example/manifests/access/
</code></pre><p>通过以上命令创建这两个资源。然后再次打开我们的示例应用程序，就会看到对应的计数正在逐步增加（因为请求被放行了） 。</p><p><em>以上示例来自于<a href=https://github.com/openservicemesh/osm>项目仓库</a> 中的示例。</em></p><h2 id=dashboard>Dashboard</h2><p>通过 <code>osm dashboard</code> 可直接唤起本地浏览器，并 port-foward 将 Grafana 打开。</p><p><img src=/img/osm-dashboard.png alt></p><h2 id=总结>总结</h2><p>Open Service Mesh 相对来说，确实很轻量。 所需要的访问控制，流量切割等功能通过自己创建 SMI 资源来控制。</p><p>并且，在同一个集群内可存在多组 mesh ，osm 安装的时候，可指定 mesh 名称。</p><p>此外，这个项目也是微软在 Service Mesh 方向的又一个大动作了。目标也许是 Istio 。让我们拭目以待。</p><hr><p>欢迎订阅我的文章公众号【MoeLove】</p><p><img src=https://raw.githubusercontent.com/tao12345666333/collection/master/images/my_qrcode.jpg alt=TheMoeLove></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>文章作者</span>
<span class=item-content>张晋涛</span></p><p class=copyright-item><span class=item-title>上次更新</span>
<span class=item-content>2020-08-07</span></p><p class=copyright-item><span class=item-title>许可协议</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank>CC BY-SA 4.0</a></span></p></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://raw.githubusercontent.com/tao12345666333/collection/master/images/wx_pay.jpg>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://raw.githubusercontent.com/tao12345666333/collection/master/images/alipay.jpg>
<span>支付宝打赏</span></label></div></div><footer class=post-footer><div class=post-tags><a href=/tags/kubernetes/>Kubernetes</a>
<a href=/tags/istio/>Istio</a>
<a href=/tags/servicemesh/>servicemesh</a></div><nav class=post-nav><a class=prev href=/2020/08/09/K8S-%E7%94%9F%E6%80%81%E5%91%A8%E6%8A%A5-runc-v1.0-rc92-%E5%8F%91%E5%B8%83/><i class="iconfont icon-left"></i><span class="prev-text nav-default">K8S 生态周报| runc v1.0-rc92 发布</span>
<span class="prev-text nav-mobile">上一篇</span></a>
<a class=next href=/2020/08/02/K8S-%E7%94%9F%E6%80%81%E5%91%A8%E6%8A%A5-Istio-%E5%B7%B2%E4%BF%AE%E5%A4%8D%E5%AF%BC%E8%87%B4-Pod-%E5%B4%A9%E6%BA%83%E7%9A%84-bug/><span class="next-text nav-default">K8S 生态周报| Istio 已修复导致 Pod 崩溃的 bug</span>
<span class="next-text nav-mobile">下一篇</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js crossorigin=anonymous></script><script type=text/javascript>var gitalk=new Gitalk({id:'2020-08-07 00:19:13 \x2b0800 CST',title:'初试 Open Service Mesh（OSM）',clientID:'68312db64e870efbd0a0',clientSecret:'a062c51a15de76546aa52351e0dd5b3cfb0cc7d8',repo:'tao12345666333.github.io',owner:'tao12345666333',admin:['tao12345666333'],body:decodeURI(location.href)});gitalk.render('gitalk-container');</script><noscript>Please enable JavaScript to view the <a href=https://github.com/gitalk/gitalk>comments powered by gitalk.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:zhangjintao9020@gmail.com class="iconfont icon-email" title=email></a><a href=https://twitter.com/BeierTao class="iconfont icon-twitter" title=twitter></a><a href=https://github.com/tao12345666333 class="iconfont icon-github" title=github></a><a href=http://weibo.com/9020taobeier class="iconfont icon-weibo" title=weibo></a><a href=https://www.zhihu.com/people/TaoBeier class="iconfont icon-zhihu" title=zhihu></a><a href=https://moelove.info/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动</span>
<span class=division>|</span>
<span class=theme-info>主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2013 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>张晋涛</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script type=text/javascript src=/lib/jquery/jquery-3.2.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/lib/fancybox/jquery.fancybox-3.1.20.min.js></script><script type=text/javascript src=/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js></script></body></html>